<!-- User Profile Page -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile - UrbanThreadz</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body>
    <header class="text-white py-4">
      <div class="container">
        <h1 class="text-center mb-0">UrbanThreadz</h1>
      </div>
    </header>

    <nav class="navbar navbar-expand-lg navbar-dark border-bottom">
      <div class="container">
        <div class="w-100 d-flex justify-content-center position-relative">
          <div class="navbar-nav">
            <a class="nav-link me-4" href="index.html">Homepage</a>
            <a class="nav-link me-4" href="products.html">Products</a>
            <a class="nav-link cart-icon" href="cart.html">
              <i class="bi bi-bag-heart fs-5"></i>
              <span
                class="cart-count badge bg-danger rounded-pill ms-1"
                id="cartCount"
                >0</span
              >
            </a>
          </div>
          <div class="navbar-nav position-absolute" style="right: 0">
            <a class="nav-link me-3" href="login.html">Login</a>
            <a class="btn btn-primary signup-btn" href="register.html"
              >Sign Up for Free</a
            >
          </div>
        </div>
      </div>
    </nav>
    <main>
      <!-- Page Header -->
      <section class="hero-section bg-light py-4">
        <div class="container">
          <h2 class="display-6 fw-bold mb-2">User Profile</h2>
          <p class="lead text-muted mb-0">
            Manage your account and preferences
          </p>
        </div>
      </section>

      <section id="profile-info" class="container py-5">
        <!-- Loading state -->
        <div id="profile-loading" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="text-muted mt-3">Loading profile information...</p>
        </div>
        <!-- User info and order history in a row -->
        <div class="row">
          <!-- Profile Info Left -->
          <div class="col-md-8">
            <div id="profile-content" class="d-none h-100">
              <div class="card shadow-sm mb-4 h-100" id="profile-info-card">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-4">
                    <!-- Profile Image Section -->
                    <div class="me-3 position-relative">
                      <div
                        class="profile-image-container position-relative"
                        style="width: 80px; height: 80px"
                      >
                        <img
                          id="profile-image"
                          class="rounded-circle object-fit-cover position-absolute"
                          style="
                            width: 100%;
                            height: 100%;
                            display: none;
                            z-index: 2;
                          "
                          alt="Profile Picture"
                        />
                        <div
                          id="profile-image-placeholder"
                          class="bg-primary rounded-circle d-flex align-items-center justify-content-center position-absolute"
                          style="width: 100%; height: 100%; z-index: 1"
                        >
                          <i class="bi bi-person-fill text-white fs-3"></i>
                        </div>
                        <!-- Camera icon overlay (only visible in edit mode) -->
                        <div
                          class="profile-edit d-none position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center"
                          style="z-index: 3"
                        >
                          <input
                            type="file"
                            id="profile-image-input"
                            accept="image/*"
                            class="d-none"
                          />
                          <button
                            type="button"
                            class="btn btn-dark btn-sm rounded-circle d-flex align-items-center justify-content-center"
                            style="
                              width: 32px;
                              height: 32px;
                              background-color: rgba(0, 0, 0, 0.7);
                              border: none;
                            "
                            onclick="document.getElementById('profile-image-input').click()"
                            title="Change Profile Picture"
                          >
                            <i class="bi bi-camera text-white"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                    <div class="flex-grow-1">
                      <h3 class="mb-0" id="profile-username">Username</h3>
                      <p class="text-muted mb-0" id="profile-email">
                        email@example.com
                      </p>
                    </div>
                    <div>
                      <button
                        class="btn btn-outline-primary btn-sm"
                        id="edit-profile-btn"
                      >
                        <i class="bi bi-pencil me-1"></i>Edit Profile
                      </button>
                      <button
                        class="btn btn-success btn-sm d-none"
                        id="save-profile-btn"
                      >
                        <i class="bi bi-check me-1"></i>Save Changes
                      </button>
                      <button
                        class="btn btn-secondary btn-sm d-none ms-2"
                        id="cancel-edit-btn"
                      >
                        <i class="bi bi-x me-1"></i>Cancel
                      </button>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label"
                        ><strong>First Name:</strong></label
                      >
                      <p
                        class="text-muted profile-display"
                        id="profile-first-name"
                      >
                        -
                      </p>
                      <input
                        type="text"
                        class="form-control profile-edit d-none"
                        id="edit-first-name"
                        placeholder="Enter first name"
                      />
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label"
                        ><strong>Last Name:</strong></label
                      >
                      <p
                        class="text-muted profile-display"
                        id="profile-last-name"
                      >
                        -
                      </p>
                      <input
                        type="text"
                        class="form-control profile-edit d-none"
                        id="edit-last-name"
                        placeholder="Enter last name"
                      />
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label"><strong>Phone:</strong></label>
                      <p class="text-muted profile-display" id="profile-phone">
                        -
                      </p>
                      <input
                        type="tel"
                        class="form-control profile-edit d-none"
                        id="edit-phone"
                        placeholder="Enter phone number"
                      />
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label"
                        ><strong>Member Since:</strong></label
                      >
                      <p class="text-muted" id="profile-created">-</p>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label"
                        ><strong>Street Address:</strong></label
                      >
                      <p class="text-muted profile-display" id="profile-street">
                        -
                      </p>
                      <input
                        type="text"
                        class="form-control profile-edit d-none"
                        id="edit-street"
                        placeholder="Enter street address"
                      />
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label"><strong>City:</strong></label>
                      <p class="text-muted profile-display" id="profile-city">
                        -
                      </p>
                      <input
                        type="text"
                        class="form-control profile-edit d-none"
                        id="edit-city"
                        placeholder="Enter city"
                      />
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label"
                        ><strong>Province:</strong></label
                      >
                      <p
                        class="text-muted profile-display"
                        id="profile-province"
                      >
                        -
                      </p>
                      <input
                        type="text"
                        class="form-control profile-edit d-none"
                        id="edit-province"
                        placeholder="Enter province"
                      />
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label"
                        ><strong>Barangay:</strong></label
                      >
                      <p
                        class="text-muted profile-display"
                        id="profile-barangay"
                      >
                        -
                      </p>
                      <input
                        type="text"
                        class="form-control profile-edit d-none"
                        id="edit-barangay"
                        placeholder="Enter barangay"
                      />
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label"
                        ><strong>Account Status:</strong></label
                      >
                      <p class="text-muted" id="profile-status">-</p>
                    </div>
                  </div>
                  <div class="d-flex gap-2 mt-4">
                    <a href="products.html" class="btn btn-primary">
                      <i class="bi bi-bag-heart me-2"></i>Shop Now
                    </a>
                    <a href="cart.html" class="btn btn-outline-primary">
                      <i class="bi bi-cart me-2"></i>View Cart
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Order History Right -->
          <div class="col-md-4">
            <div
              class="card shadow-sm mt-4 mt-md-0 h-100"
              id="order-history-card"
              style="height: 100%; min-height: 400px"
            >
              <div class="card-header">
                <h5 class="mb-0">
                  <i class="bi bi-clock-history me-2"></i>Order History
                </h5>
              </div>
              <div class="card-body p-0" style="height: 100%">
                <div
                  style="
                    max-height: 600px;
                    height: calc(100vh - 300px);
                    overflow-y: auto;
                    padding: 1rem;
                  "
                  id="order-history-scroll"
                >
                  <div id="order-history-loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-3">Loading order history...</p>
                  </div>
                  <div id="order-history-content" class="d-none">
                    <!-- Orders will be displayed here -->
                  </div>
                  <div id="no-orders" class="text-center py-4 d-none">
                    <i class="bi bi-bag-x fs-3 text-muted mb-3"></i>
                    <p class="text-muted">No orders found</p>
                    <a href="products.html" class="btn btn-primary">
                      <i class="bi bi-bag-heart me-2"></i>Start Shopping
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Not logged in message -->
        <div id="not-logged-in" class="text-center py-5 d-none">
          <div class="alert alert-warning d-inline-block">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Please log in to view your profile
          </div>
          <div class="mt-3">
            <a href="login.html" class="btn btn-primary me-2">Login</a>
            <a href="register.html" class="btn btn-outline-primary">Sign Up</a>
          </div>
        </div>
      </section>
      <style>
        @media (min-width: 768px) {
          #profile-info .row {
            align-items: stretch;
          }
          #profile-info-card,
          #order-history-card {
            height: 100%;
          }
          #order-history-scroll {
            height: 100%;
            min-height: 400px;
          }
        }
      </style>
    </main>

    <footer class="text-white py-4">
      <div class="container">
        <div class="row">
          <div class="col-md-4 mb-4">
            <h5>UrbanThreadz</h5>
            <p>Your go-to destination for trendy and affordable fashion.</p>
          </div>
          <div class="col-md-4 mb-4">
            <h5>Quick Links</h5>
            <ul class="list-unstyled">
              <li><a href="index.html" class="text-white-50">Home</a></li>
              <li>
                <a href="products.html" class="text-white-50">Products</a>
              </li>
              <li><a href="login.html" class="text-white-50">Login</a></li>
              <li>
                <a href="register.html" class="text-white-50">Register</a>
              </li>
            </ul>
          </div>
          <div class="col-md-4 mb-4">
            <h5>Follow Us</h5>
            <div class="social-links">
              <a href="#" class="text-white-50 me-3"
                ><i class="bi bi-facebook fs-4"></i
              ></a>
              <a href="#" class="text-white-50 me-3"
                ><i class="bi bi-instagram fs-4"></i
              ></a>
              <a href="#" class="text-white-50 me-3"
                ><i class="bi bi-twitter fs-4"></i
              ></a>
              <a href="#" class="text-white-50"
                ><i class="bi bi-youtube fs-4"></i
              ></a>
            </div>
          </div>
        </div>
        <hr class="my-4" />
        <div class="text-center">
          <p class="mb-0">&copy; 2025 UrbanThreadz. All rights reserved.</p>
        </div>
      </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/script.js?v=3"></script>

    <script>
      // Limit phone input to 11 digits
      document.addEventListener('DOMContentLoaded', function () {
        var phoneInput = document.getElementById('edit-phone');
        if (phoneInput) {
          phoneInput.addEventListener('input', function (e) {
            // Remove non-digit characters
            let value = e.target.value.replace(/\D/g, '');
            // Limit to 11 digits
            if (value.length > 11) value = value.slice(0, 11);
            e.target.value = value;
          });
        }
      });

      // Load order history when profile page loads
      document.addEventListener("DOMContentLoaded", function () {
        // Load order history after profile loads
        setTimeout(loadOrderHistory, 1000);
      });

      function loadOrderHistory() {
        console.log("Loading order history...");
        const orderHistoryLoading = document.getElementById(
          "order-history-loading"
        );
        const orderHistoryContent = document.getElementById(
          "order-history-content"
        );
        const noOrdersDiv = document.getElementById("no-orders");

        // Use debug endpoint first to test
        fetch("php/debug_orders.php")
          .then((response) => {
            console.log("Order history response:", response);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            console.log("Order history data:", data);
            orderHistoryLoading.classList.add("d-none");

            if (!data.success) {
              // Show error with details
              noOrdersDiv.classList.remove("d-none");
              noOrdersDiv.innerHTML = `
                            <i class="bi bi-exclamation-triangle fs-3 text-warning mb-3"></i>
                            <p class="text-muted">Error: ${data.error}</p>
                            <pre class="text-muted small">${JSON.stringify(
                              data,
                              null,
                              2
                            )}</pre>
                            <button class="btn btn-outline-primary" onclick="loadOrderHistory()">
                                <i class="bi bi-arrow-clockwise me-2"></i>Try Again
                            </button>
                        `;
              return;
            }

            const orders = data.orders || [];
            console.log("User orders:", orders);

            if (orders.length === 0) {
              noOrdersDiv.classList.remove("d-none");
              noOrdersDiv.innerHTML = `
                            <i class="bi bi-bag-x fs-3 text-muted mb-3"></i>
                            <p class="text-muted">No orders found</p>
                            <p class="text-muted small">Total orders in system: ${data.total_orders}</p>
                            <a href="products.html" class="btn btn-primary">
                                <i class="bi bi-bag-heart me-2"></i>Start Shopping
                            </a>
                        `;
            } else {
              orderHistoryContent.classList.remove("d-none");
              displayOrderHistory(orders);
            }
          })
          .catch((error) => {
            console.error("Error loading order history:", error);
            orderHistoryLoading.classList.add("d-none");
            noOrdersDiv.classList.remove("d-none");
            noOrdersDiv.innerHTML = `
                        <i class="bi bi-exclamation-triangle fs-3 text-warning mb-3"></i>
                        <p class="text-muted">Network error loading order history</p>
                        <p class="text-muted small">${error.message}</p>
                        <button class="btn btn-outline-primary" onclick="loadOrderHistory()">
                            <i class="bi bi-arrow-clockwise me-2"></i>Try Again
                        </button>
                    `;
          });
      }

      function displayOrderHistory(orders) {
        console.log("Displaying order history for orders:", orders);
        const orderHistoryContent = document.getElementById(
          "order-history-content"
        );

        // Sort orders by date (newest first) - defensive programming
        orders.sort((a, b) => {
          const dateA = a.orderDate ? new Date(a.orderDate).getTime() : 0;
          const dateB = b.orderDate ? new Date(b.orderDate).getTime() : 0;
          return dateB - dateA;
        });

        let ordersHTML = "";

        orders.forEach((order) => {
          const orderDate = order.orderDate
            ? new Date(order.orderDate)
            : new Date();
          const formattedDate = orderDate.toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });

          const status = order.status || "pending";
          const statusClass = getStatusClass(status);
          const totalAmount = order.totals
            ? order.totals.total
            : order.total || 0;
          const itemCount = order.items ? order.items.length : 0;

          ordersHTML += `
                    <div class="border rounded p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="mb-1">Order #${order.orderId}</h6>
                                <small class="text-muted">${formattedDate}</small>
                            </div>
                            <span class="badge ${statusClass}">${status.toUpperCase()}</span>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">Items: ${itemCount}</small>
                            </div>
                            <div class="col-md-6 text-end">
                                <strong>₱${totalAmount.toFixed(2)}</strong>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="viewOrderDetails('${
                              order.orderId
                            }')">
                                <i class="bi bi-eye me-1"></i>View Details
                            </button>
                            ${
                              order.items
                                ? `
                            <button class="btn btn-sm btn-outline-success" onclick="reorderItems('${order.orderId}')">
                                <i class="bi bi-arrow-repeat me-1"></i>Reorder
                            </button>
                            `
                                : ""
                            }
                        </div>
                    </div>
                `;
        });

        orderHistoryContent.innerHTML = ordersHTML;
      }

      function getStatusClass(status) {
        switch (status.toLowerCase()) {
          case "pending":
            return "bg-warning";
          case "processing":
            return "bg-info";
          case "shipped":
            return "bg-primary";
          case "delivered":
            return "bg-success";
          case "cancelled":
            return "bg-danger";
          default:
            return "bg-secondary";
        }
      }

      function viewOrderDetails(orderId) {
        // Get order details from server
        fetch(`php/get_order.php?orderId=${orderId}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.success && data.order) {
              showOrderDetailsModal(data.order);
            } else {
              alert("Order not found or access denied");
            }
          })
          .catch((error) => {
            console.error("Error loading order details:", error);
            alert("Error loading order details");
          });
      }

      function showOrderDetailsModal(order) {
        const modalHTML = `
                <div class="modal fade" id="orderDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Order Details - #${
                                  order.orderId
                                }</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <strong>Order Date:</strong><br>
                                        <span class="text-muted">${new Date(
                                          order.orderDate
                                        ).toLocaleDateString("en-US", {
                                          year: "numeric",
                                          month: "long",
                                          day: "numeric",
                                          hour: "2-digit",
                                          minute: "2-digit",
                                        })}</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Status:</strong><br>
                                        <span class="badge ${getStatusClass(
                                          order.status
                                        )}">${order.status.toUpperCase()}</span>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <strong>Customer:</strong><br>
                                        <span class="text-muted">${
                                          order.customer.firstName
                                        } ${order.customer.lastName}</span><br>
                                        <span class="text-muted">${
                                          order.customer.email
                                        }</span><br>
                                        <span class="text-muted">${
                                          order.customer.phone
                                        }</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Shipping Address:</strong><br>
                                        <span class="text-muted">
                                            ${order.shipping.address}<br>
                                            ${order.shipping.city}, ${
          order.shipping.state
        }<br>
                                            ${order.shipping.zipCode}
                                        </span>
                                    </div>
                                </div>
                                
                                <h6>Order Items:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Item</th>
                                                <th>Quantity</th>
                                                <th>Price</th>
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${order.items
                                              .map(
                                                (item) => `
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <img src="${
                                                              item.image
                                                            }" alt="${
                                                  item.name
                                                }" class="me-2 rounded" style="width: 40px; height: 40px; object-fit: cover;">
                                                            <div>
                                                                <div class="fw-bold">${
                                                                  item.name
                                                                }</div>
                                                                <small class="text-muted">${
                                                                  item.size
                                                                    ? `Size: ${item.size}`
                                                                    : ""
                                                                } ${
                                                  item.color
                                                    ? `Color: ${item.color}`
                                                    : ""
                                                }</small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>${item.quantity}</td>
                                                    <td>₱${item.price.toFixed(
                                                      2
                                                    )}</td>
                                                    <td>₱${(
                                                      item.price * item.quantity
                                                    ).toFixed(2)}</td>
                                                </tr>
                                            `
                                              )
                                              .join("")}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-md-6 ms-auto">
                                        <div class="d-flex justify-content-between">
                                            <span>Subtotal:</span>
                                            <span>₱${order.totals.subtotal.toFixed(
                                              2
                                            )}</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Shipping:</span>
                                            <span>₱${order.totals.shipping.toFixed(
                                              2
                                            )}</span>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between fw-bold">
                                            <span>Total:</span>
                                            <span>₱${order.totals.total.toFixed(
                                              2
                                            )}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="reorderItems('${
                                  order.orderId
                                }')">Reorder</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

        // Remove existing modal if any
        const existingModal = document.getElementById("orderDetailsModal");
        if (existingModal) {
          existingModal.remove();
        }

        // Add modal to page
        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // Show modal
        const modal = new bootstrap.Modal(
          document.getElementById("orderDetailsModal")
        );
        modal.show();
      }

      function reorderItems(orderId) {
        // Get order details and add items to cart
        fetch(`php/get_order.php?orderId=${orderId}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.success && data.order && data.order.items) {
              // Add each item to cart
              data.order.items.forEach((item) => {
                addToCart(item.id, item.quantity, item.size, item.color);
              });

              // Show success message
              showToast("Items added to cart successfully!", "success");

              // Update cart count
              updateCartCount();

              // Close modal if open
              const modalElement = document.getElementById("orderDetailsModal");
              if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                  modal.hide();
                }
              }
            } else {
              showToast("Error loading order items", "error");
            }
          })
          .catch((error) => {
            console.error("Error reordering items:", error);
            showToast("Error adding items to cart", "error");
          });
      }
    </script>
  </body>
</html>
